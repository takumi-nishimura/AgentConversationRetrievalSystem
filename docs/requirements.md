# 要件定義書: Agent Conversation Retrieval System (ACRS)

**バージョン**: 1.0
**作成日**: 2025年4月26日
**作成者**: Gemini (AI Assistant)

## 1. 概要

### 1.1. プロジェクト名
Agent Conversation Retrieval System (ACRS) (仮称)

### 1.2. プロジェクトの目的
本プロジェクトは、エージェント間の会話履歴（特にその要約）を効率的に検索するシステムを構築し、将来的にエージェントが過去の会話内容を参照して、より文脈に即した質の高い発話を生成する機能の実現可能性を**検証**することを目的とする。

### 1.3. 背景
エージェントシステムにおいて、過去の対話履歴を効果的に参照する能力は、文脈理解、一貫性維持、知識獲得の観点から重要である。本システムは、そのためのコアとなる会話検索機能を提供する。

### 1.4. スコープ
* エージェント間の会話データの**要約**を生成し、データベースに格納する。
* 格納された会話**要約**に対し、ハイブリッド検索（ベクトル検索 + 全文検索）およびリランキングを実行する機能を提供する。
* 検索機能のバックエンドロジックの実装に焦点を当て、UIやAPIは開発しない。

## 2. 機能要件

### 2.1. 会話データの管理
* **2.1.1. 会話データの格納**: エージェント間の会話の生データ（発話テキスト、話者、タイムスタンプ等）をデータベースに格納する。
* **2.1.2. 会話要約の生成**: 格納された会話データに基づき、会話セッションごと（または適切な単位で）の要約を生成する。
    * **タイミング**: 会話セッション終了後、非同期で実行されることを想定。
    * **使用LLM**: Ollama経由で `hf.co/mmnga/ArrowMint-Gemma3-4B-YUKI-v0.1-gguf:latest` モデルを利用することを想定（LiteLLM経由）。
* **2.1.3. 要約と埋め込みの格納**: 生成された要約テキストと、それに対応する埋め込みベクトルをデータベースに格納する。
    * **埋め込みモデル**: `pfnet/plamo-embedding-1b` を使用する。

### 2.2. ハイブリッド検索機能
* **2.2.1. 検索インターフェース**: 内部的な関数・メソッド呼び出しによる検索実行を想定（UI/APIは不要）。入力として検索クエリ（テキスト）を受け取る。
* **2.2.2. 検索対象**: データベースに格納された会話の**要約**テキスト。
* **2.2.3. ベクトル検索**: 入力クエリの埋め込みベクトルを計算し、DB内の要約ベクトルと類似度が高い上位5件の要約IDを取得する。
* **2.2.4. 全文検索**: 入力クエリに基づき、DB内の要約テキストに対して全文検索を行い、関連度が高い上位5件の要約IDを取得する。
* **2.2.5. 結果のマージ**: ベクトル検索と全文検索の結果（最大10件のユニークな要約IDリスト）をマージする。
* **2.2.6. リランキング**: マージされた候補リスト（要約IDとその要約テキスト）と元の検索クエリを入力とし、リランカーモデルを用いて再度スコアリングし、最終的なランキング結果（要約IDの順序付きリスト）を返す。
    * **リランカーモデル**: `hotchpotch/japanese-reranker-cross-encoder-large-v1` を使用する。
* **2.2.7. 検索結果**: 最終的なランキング結果（要約IDのリスト）を返す。必要に応じて、IDに対応する要約テキストや元の会話全文を取得できるインターフェースも用意する。

## 3. 非機能要件

### 3.1. 性能
* **検索応答時間**: 検索クエリを受け付けてから最終的なランキング結果（要約IDリスト）を返すまでの処理時間が、**95パーセンタイルで500ミリ秒以内**であること。

### 3.2. 信頼性
* 検索処理中にエラーが発生した場合、エラー情報をログに出力し、処理は失敗として終了する（エージェント側で適切にハンドリングすることを想定）。
* DB接続エラー、LLM APIエラー、モデル推論エラーなどを適切にハンドリングする。

### 3.3. 保守性
* ソースコードはモジュール化され、可読性が高く、単体テストが可能な構造とする。
* 主要な設定値（モデル名、DBパス、ログレベル等）は設定ファイルで管理する。
* 標準的なPythonプロジェクト構成に従う。

### 3.4. 運用性
* **ログ**: 主要な処理の実行状況、処理時間（ミリ秒単位）、エラー情報を記録する。ログレベル（DEBUG, INFO, WARNING, ERROR）を設定可能にする。ログは標準出力およびファイルに出力する。
* **依存関係**: `requirements.txt` でライブラリのバージョンを管理する。

### 3.5. セキュリティ
* 本要件定義のスコープでは、特別なアクセス制御やデータ暗号化は必須としない。ただし、機密情報を含む会話データを扱う場合は、将来的に考慮が必要。

## 4. 技術仕様

### 4.1. プログラミング言語
* Python 3.10 以上

### 4.2. 主要ライブラリ・フレームワーク
* **LLM連携**: `litellm`, `ollama` Pythonクライアント
* **埋め込み/リランキング**: `transformers`, `torch`
* **データベース**: `duckdb`
* **ベクトル検索**: `duckdb` VSS拡張機能 (想定)
* **全文検索**: `lindera` (または `duckdb` のfts拡張機能 + 日本語トークナイザ連携)
* **その他**: `numpy`, `logging` など

### 4.3. データベース設計 (概要)
* **DBエンジン**: DuckDB
* **テーブル**:
    * `conversations`: 会話の生データ (id, session_id, agent_id, utterance_text, timestamp, created_at)
    * `conversation_summaries`: 要約とベクトル (id, conversation_session_id, summary_text, embedding, created_at)
* **インデックス**:
    * `conversation_summaries.embedding` にベクトル検索インデックス (HNSW等)
    * `conversation_summaries.summary_text` に全文検索インデックス (Lindera等でトークナイズ)

### 4.4. ディレクトリ構成 (案)
acrs/
├── src/
│   ├── core/          # コアロジック (検索、インデックス管理)
│   ├── db/            # DB接続、スキーマ定義
│   ├── llm/           # LLM連携 (要約生成、埋め込み)
│   ├── utils/         # ユーティリティ関数
│   └── config.py      # 設定管理
├── docs/            # ドキュメント（要件定義など）
├── tests/           # テストコード
├── scripts/         # 補助スクリプト
├── logs/            # ログファイル出力先
├── data/            # テスト用データなど
├── requirements.txt # 依存ライブラリ
└── README.md        # プロジェクト説明

## 5. その他

### 5.1. 開発プロセス
* Gitによるバージョン管理を行う。
* 基本的なテストコードを作成する（特に検索ロジック部分）。

### 5.2. 評価方法
* 開発段階では、定義済みのテストクエリに対する検索結果の目視確認を行う。
* 性能要件（500ms）を満たしているか、ログに出力される処理時間で確認する。
* 将来的には、より定量的な評価指標（MRR, Recall@kなど）の導入も検討する。
